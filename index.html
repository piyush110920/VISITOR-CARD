<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Card Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for smoother transitions */
        .transition-all-colors {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 p-6 min-h-screen flex items-center justify-center font-sans">
    <div class="max-w-4xl w-full mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
<div class="text-center mb-10">
    <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600 mb-2 drop-shadow-md tracking-tight">
        SenseLive Technology
    </h1>
    <p class="text-xl sm:text-2xl font-semibold text-gray-600 mt-2">
        Visitor Card Extractor & Mailer
    </p>
</div>
        <form id="mainForm" class="space-y-6">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="sheetId" class="block text-sm font-medium text-gray-700">Google Sheet ID</label>
                    <input id="sheetId" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 border" placeholder="Enter Google Sheet ID" required>
                </div>
                <div>
                    <label for="gid" class="block text-sm font-medium text-gray-700">Google Sheet GID</label>
                    <input id="gid" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 border" placeholder="Enter GID (e.g. 0)" required>
                </div>
            </div>

            <div>
                <label for="imageUpload" class="block text-sm font-medium text-gray-700">Upload or Capture Image</label>
                <div class="mt-1 flex items-center space-x-4">
                    <input id="imageUpload" type="file" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <button type="button" onclick="captureImage()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all-colors">
                        Click Image
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <label for="cardName" class="block text-sm font-medium text-gray-700">Card Name</label>
                <input id="cardName" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 border" placeholder="Enter Card Name">
            </div>

            <div>
                <label for="requirements" class="block text-sm font-medium text-gray-700">Requirements (Optional)</label>
                <textarea id="requirements" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 border" rows="3" placeholder="Any notes..."></textarea>
            </div>

            <div class="pt-2">
                <button id="uploadButton" type="button" onclick="uploadImage()" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-bold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all-colors">
                    <span id="buttonText">Upload</span>
                </button>
            </div>

        </form>

        <div id="previewSection" class="mt-10 hidden">
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Verify Extracted Data</h2>
                <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                    <table class="min-w-full divide-y divide-gray-300" id="dataPreview">
                        <tbody class="divide-y divide-gray-200 bg-white">
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="saveData()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all-colors">
                        Save Data to Sheet
                    </button>
                    <button type="button" onclick="saveAndMail()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all-colors">
                        Save Data + Send Mail
                    </button>
                </div>
            </div>
        </div>

        <div id="templateSection" class="mt-6 hidden">
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Choose Email Template</h2>
                <select id="templateSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 border mb-4">
                    <option value="template1">Template 1: Welcome Email</option>
                    <option value="template2">Template 2: Meeting Confirmation</option>
                    <option value="template3">Template 3: Thank You</option>
                    <option value="template4">Template 4: Follow-up</option>
                    <option value="template5">Template 5: Custom Offer</option>
                </select>
                <button type="button" onclick="sendMail()" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all-colors">
                    Send Mail
                </button>
            </div>
        </div>
    </div>

    <script>
        let extractedData = {};
        let webhookUrl = "/api/upload";

        async function uploadImage() {
            const uploadButton = document.getElementById('uploadButton');
            const buttonText = document.getElementById('buttonText');

            // Set button to loading state
            uploadButton.disabled = true;
            uploadButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            uploadButton.classList.add('bg-green-300', 'cursor-not-allowed');
            buttonText.textContent = 'Uploading...';

            let formData = new FormData();
            formData.append("sheetId", document.getElementById("sheetId").value);
            formData.append("gid", document.getElementById("gid").value);
            formData.append("requirements", document.getElementById("requirements").value);
            formData.append("action", "upload");
            formData.append("cardName", document.getElementById("cardName").value);
            let file = document.getElementById("imageUpload").files[0];
            if (file) formData.append("image", file);

            try {
                let res = await fetch(webhookUrl, { method: "POST", body: formData });
                let data = await res.json();
                extractedData = data;
                renderPreview(data);

                // Set button to success state
                buttonText.textContent = 'Done';
                uploadButton.classList.remove('bg-green-300');
                uploadButton.classList.add('bg-green-600', 'hover:bg-green-700');

            } catch (error) {
                console.error("Upload failed:", error);
                buttonText.textContent = 'Upload Failed';
                uploadButton.classList.remove('bg-green-300');
                uploadButton.classList.add('bg-red-600', 'hover:bg-red-700');

            } finally {
                uploadButton.disabled = false;
            }
        }

        function renderPreview(data) {
            let table = document.getElementById("dataPreview");
            table.innerHTML = "";

            for (const key in data) {
                if (Object.hasOwnProperty.call(data, key)) {
                    let row = document.createElement("tr");

                    let keyCell = document.createElement("td");
                    keyCell.className = "border p-2 font-medium";
                    keyCell.textContent = key;
                    row.appendChild(keyCell);

                    let valueCell = document.createElement("td");
                    valueCell.className = "border p-2";
                    let input = document.createElement("input");
                    input.className = "w-full border p-1";
                    input.value = data[key] || "";
                    input.setAttribute("data-key", key);
                    valueCell.appendChild(input);
                    row.appendChild(valueCell);

                    table.appendChild(row);
                }
            }

            document.getElementById("previewSection").classList.remove("hidden");
        }

        function collectData() {
            let inputs = document.querySelectorAll("#dataPreview input");
            let verified = {};
            inputs.forEach(i => verified[i.dataset.key] = i.value);
            return verified;
        }

        async function saveData() {
            let verified = collectData();
            verified.action = "save";
            await fetch(webhookUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(verified)
            });
            alert("Data saved to sheet!");
        }

        function saveAndMail() {
            document.getElementById("templateSection").classList.remove("hidden");
        }

        async function sendMail() {
            let verified = collectData();
            verified.action = "sendMail";
            verified.template = document.getElementById("templateSelect").value;
            await fetch(webhookUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(verified)
            });
            alert("Data saved & mail sent!");
        }

        function captureImage() {
            let input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.capture = "environment";
            input.onchange = e => document.getElementById("imageUpload").files = e.target.files;
            input.click();
        }
    </script>
</body>
</html>